name: Deploy to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/apps/pnth-degen
            git fetch origin
            git reset --hard origin/main
            
            export COMPOSE_PROJECT_NAME=pnth-degen
            docker compose build --no-cache
            docker compose up -d
            docker image prune -f
            
            echo "Waiting for container..."
            sleep 10
            
            for i in 1 2 3 4 5 6; do
              if curl -sf https://degen.pnth.app > /dev/null; then
                echo "✅ Deploy successful"
                exit 0
              fi
              echo "Attempt $i/6 - waiting..."
              sleep 5
            done
            
            echo "❌ Health check failed"
            exit 1
